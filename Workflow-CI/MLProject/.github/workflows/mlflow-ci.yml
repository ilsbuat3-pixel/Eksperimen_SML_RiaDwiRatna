name: MLflow CI/CD Training

on:
  push:
    branches: [ main, master ]
    paths:
      - 'modelling.py'
      - 'conda.yaml'
      - 'MLproject'
      - 'data/**'
      - '.github/workflows/mlflow-ci.yml'
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly training
  workflow_dispatch:  # Manual trigger

jobs:
  mlflow-training:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    - name: Check Environment
      run: |
        python --version
        echo "Starting MLflow CI/CD Pipeline"
        
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        
    - name: Run MLflow Project
      id: run-mlflow
      run: |
        echo "Running MLflow project..."
        mlflow run . --experiment-name "ci-cd-training"
        
    - name: Find Latest Run ID
      id: find-run
      run: |
        if [ -d "mlruns" ]; then
          # Cari run ID terbaru
          RUN_ID=$(find mlruns -name "meta.yaml" -type f | xargs grep -h "run_id:" | cut -d' ' -f2 | head -1)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Latest run ID: $RUN_ID"
        fi
        
    - name: Upload Training Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-artifacts
        path: |
          mlruns/
          *.pkl
          *.json
        retention-days: 30
        
    # --- SKILLED LEVEL ---
    - name: Save Model to GitHub
      if: success()
      run: |
        mkdir -p trained_models
        # Cari model terbaru
        if [ -d "mlruns" ]; then
          MODEL_PATH=$(find mlruns -name "model.pkl" -o -name "*.joblib" | head -1)
          if [ -n "$MODEL_PATH" ]; then
            cp "$MODEL_PATH" "trained_models/model_${{ github.run_number }}.pkl"
            echo "✅ Model saved"
          fi
        fi
        
    # --- ADVANCED LEVEL ---
    - name: Build Docker Image with MLflow
      if: success() && github.event_name != 'pull_request'
      id: build-docker
      run: |
        echo "Building Docker image..."
        pip install mlflow[extras]
        
        # Build docker dari model MLflow
        mlflow models build-docker \
          -m "runs:/${{ steps.find-run.outputs.run_id }}/model" \
          -n "mlflow-model-${{ github.sha:0:8 }}" \
          --enable-mlserver
        
    - name: Login to Docker Hub
      if: success() && github.event_name != 'pull_request'
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Tag and Push Docker Image
      if: success() && github.event_name != 'pull_request'
      run: |
        # Tag image
        docker tag "mlflow-model-${{ github.sha:0:8 }}" "${{ secrets.DOCKER_USERNAME }}/mlflow-ci-model:${{ github.sha:0:8 }}"
        docker tag "mlflow-model-${{ github.sha:0:8 }}" "${{ secrets.DOCKER_USERNAME }}/mlflow-ci-model:latest"
        
        # Push ke Docker Hub
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-ci-model:${{ github.sha:0:8 }}"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-ci-model:latest"
        echo "✅ Docker image pushed to Docker Hub"
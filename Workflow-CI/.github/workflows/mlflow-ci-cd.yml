name: üöÄ MLflow CI/CD - Advanced (Kriteria 3)

on:
  workflow_dispatch:  # Bisa di-trigger manual
  push:
    branches: [ main ]
    paths:
      - 'MLProject/**'
      - '.github/workflows/mlflow-ci-advanced.yml'

jobs:
  train-and-dockerize:
    runs-on: ubuntu-latest
    env:
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
    
    steps:
    # ========== STEP 1: SETUP ==========
    - name: üì• Checkout repository
      uses: actions/checkout@v3
      
    - name: üêç Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # ========== STEP 2: INSTALL DEPENDENCIES ==========
    - name: üì¶ Install MLflow & dependencies
      run: |
        pip install mlflow==2.11.0
        pip install scikit-learn pandas numpy
        pip install dagshub  # Untuk tracking ke DagsHub
        
    # ========== STEP 3: RUN MLFLOW PROJECT (TRAINING) ==========
    - name: ü§ñ Run MLflow Project - Training
      id: training
      run: |
        cd MLProject
        echo "Starting MLflow training..."
        
        # Jalankan training dan capture output
        mlflow run . \
          --experiment-name="CI_Advanced_$(date +%Y%m%d_%H%M%S)" \
          2>&1 | tee run.log
        
        # Ekstrak RUN_ID dari log
        python get_run_id.py
        
    # ========== STEP 4: UPLOAD ARTIFACTS (Skilled Requirement) ==========
    - name: üíæ Upload Artifacts to GitHub
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-artifacts-${{ github.run_id }}
        path: |
          MLProject/mlruns/
          MLProject/*.png
          MLProject/*.json
          MLProject/run.log
        retention-days: 30
    
    # ========== STEP 5: BUILD DOCKER IMAGE (Advanced Requirement) ==========
    - name: üê≥ Build Docker Image with mlflow build-docker
      id: build-docker
      if: env.RUN_ID != ''
      run: |
        echo "Building Docker image for RUN_ID: ${{ env.RUN_ID }}"
        
        # Gunakan mlflow models build-docker
        mlflow models build-docker \
          -m "runs:/${{ env.RUN_ID }}/model" \
          -n "diabetes-ml-model:${{ github.sha }}" \
          --enable-mlserver
        
        echo "‚úÖ Docker image built successfully!"
        echo "Image: diabetes-ml-model:${{ github.sha }}"
    
    # ========== STEP 6: PUSH TO DOCKER HUB (Advanced Requirement) ==========
    - name: üîê Login to Docker Hub
      if: env.RUN_ID != ''
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
    
    - name: üè∑Ô∏è Tag Docker Image
      if: env.RUN_ID != ''
      run: |
        # Tag dengan username Docker Hub Anda
        docker tag diabetes-ml-model:${{ github.sha }} \
          ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:latest
        
        docker tag diabetes-ml-model:${{ github.sha }} \
          ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:${{ github.sha }}
        
        echo "Tags created:"
        echo "  - ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:latest"
        echo "  - ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:${{ github.sha }}"
    
    - name: üì§ Push Docker Image to Docker Hub
      if: env.RUN_ID != ''
      run: |
        # Push kedua tag
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:latest
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:${{ github.sha }}
        
        echo "üéâ Docker image pushed to Docker Hub!"
        echo "üîó URL: https://hub.docker.com/r/${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model"
    
    # ========== STEP 7: VERIFICATION ==========
    - name: üìã Verification Summary
      run: |
        echo "=========================================="
        echo "‚úÖ KRITERIA 3 ADVANCED - COMPLETED"
        echo "=========================================="
        echo ""
        echo "üìä What was accomplished:"
        echo "1. ‚úÖ MLflow Project executed automatically"
        echo "2. ‚úÖ Artifacts saved to GitHub"
        echo "3. ‚úÖ Docker image built with mlflow build-docker"
        echo "4. ‚úÖ Docker image pushed to Docker Hub"
        echo ""
        if [ "${{ env.RUN_ID }}" != "" ]; then
          echo "üîó MLflow Run: ${{ env.RUN_ID }}"
        fi
        echo "üê≥ Docker Image: ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model"
        echo "üöÄ Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
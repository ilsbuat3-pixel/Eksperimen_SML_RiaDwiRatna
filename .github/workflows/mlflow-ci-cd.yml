# .github/workflows/mlflow-ci-advanced.yml
name: üöÄ KRITERIA 3 - MLflow CI/CD + Docker

on:
  workflow_dispatch:  # Trigger manual dulu
  push:
    branches: [ main ]
    paths:
      - 'MLProject/**'
      - '.github/workflows/mlflow-ci-advanced.yml'

jobs:
  mlflow-docker-pipeline:
    runs-on: ubuntu-latest
    env:
      MLFLOW_TRACKING_URI: https://dagshub.com/ilsbuat3-pixel/diabetes-mlops.mlflow

    steps:
    # 1. CHECKOUT
    - name: üì• Checkout repository
      uses: actions/checkout@v3

    # 2. SETUP PYTHON
    - name: üêç Setup Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. INSTALL DEPENDENCIES
    - name: üì¶ Install dependencies
      run: |
        pip install mlflow==2.11.0
        pip install scikit-learn pandas numpy matplotlib
        pip install dagshub
        echo "‚úÖ Dependencies installed"

    # 4. RUN MLFLOW PROJECT
    - name: ü§ñ Run MLflow Training
      id: training
      run: |
        echo "Starting MLflow project..."
        cd MLProject
        
        # Jalankan training
        mlflow run . --experiment-name="CI_Advanced_${{ github.run_id }}" 2>&1 | tee run.log
        
        # Cari RUN_ID dari output
        RUN_ID=$(grep -o "Run ID: [a-f0-9]*" run.log | head -1 | cut -d' ' -f3)
        
        if [ -z "$RUN_ID" ]; then
          echo "‚ö†Ô∏è Could not extract RUN_ID from log"
          # Fallback: cari run terbaru
          RUN_ID=$(mlflow runs search --experiment-names "CI_Advanced_${{ github.run_id }}" --max-results 1 | grep -o 'run_id:"[^"]*"' | cut -d'"' -f2 || echo "")
        fi
        
        if [ -n "$RUN_ID" ]; then
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "‚úÖ Training completed. RUN_ID: $RUN_ID"
        else
          echo "‚ùå ERROR: No RUN_ID found"
          exit 1
        fi

    # 5. UPLOAD ARTIFACTS (Skilled Requirement)
    - name: üíæ Upload Artifacts to GitHub
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-artifacts-${{ github.run_id }}
        path: |
          MLProject/mlruns/
          MLProject/*.log
          MLProject/*.json
        retention-days: 7

    # 6. BUILD DOCKER IMAGE (Advanced Requirement)
    - name: üê≥ Build Docker Image
      if: env.RUN_ID != ''
      run: |
        echo "=== BUILDING DOCKER IMAGE ==="
        echo "Using RUN_ID: ${{ env.RUN_ID }}"
        echo "Model URI: runs:/${{ env.RUN_ID }}/model"
        
        # Build Docker image dari model MLflow
        mlflow models build-docker \
          -m "runs:/${{ env.RUN_ID }}/model" \
          -n "diabetes-ml-model:${{ github.sha }}" \
          --enable-mlserver
        
        echo "‚úÖ Docker image built: diabetes-ml-model:${{ github.sha }}"

    # 7. PUSH TO DOCKER HUB (Advanced Requirement)
    - name: üîê Login to Docker Hub
      if: env.RUN_ID != ''
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    - name: üè∑Ô∏è Tag and Push Docker Image
      if: env.RUN_ID != ''
      run: |
        # Tag image
        docker tag diabetes-ml-model:${{ github.sha }} ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:latest
        docker tag diabetes-ml-model:${{ github.sha }} ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:${{ github.sha }}
        
        # Push ke Docker Hub
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:latest
        docker push ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model:${{ github.sha }}
        
        echo "‚úÖ‚úÖ‚úÖ DOCKER PUSH SUCCESS!"
        echo "Image: ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model"
        echo "Tags: latest, ${{ github.sha }}"
        echo "URL: https://hub.docker.com/r/${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model"

    # 8. FINAL VERIFICATION
    - name: üìã Verification
      run: |
        echo "========================================"
        echo "üéâ KRITERIA 3 ADVANCED - COMPLETED"
        echo "========================================"
        echo ""
        echo "‚úÖ MLflow Training: Done"
        echo "‚úÖ Artifacts Uploaded: Done"
        echo "‚úÖ Docker Image Built: Done"
        echo "‚úÖ Docker Image Pushed: Done"
        echo ""
        if [ "${{ env.RUN_ID }}" != "" ]; then
          echo "üîó MLflow Run: ${{ env.RUN_ID }}"
        fi
        echo "üê≥ Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKER_HUB_USERNAME }}/diabetes-ml-model"
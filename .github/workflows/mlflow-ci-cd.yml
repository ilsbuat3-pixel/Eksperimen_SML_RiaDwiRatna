name: MLflow CI/CD Pipeline - Advanced

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Jalankan otomatis setiap hari jam 2 pagi
    - cron: '0 2 * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  setup-and-preprocess:
    runs-on: ubuntu-latest
    outputs:
      run-id: ${{ steps.mlflow-run.outputs.run-id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.7'

      - name: Install MLflow and dependencies
        run: |
          pip install mlflow boto3 pydantic scikit-learn pandas numpy
          pip install -r requirements.txt

      - name: Run MLflow Project
        id: mlflow-run
        run: |
          cd MLProject
          # Jalankan MLflow project dan capture run_id
          RUN_OUTPUT=$(mlflow run . --experiment-name="production-model" 2>&1 | grep -o "Run ID: [a-f0-9]*" || true)
          RUN_ID=${RUN_OUTPUT#Run ID: }
          if [ -n "$RUN_ID" ]; then
            echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
            echo "MLflow Run ID: $RUN_ID"
          else
            echo "run-id=manual-$(date +%s)" >> $GITHUB_OUTPUT
            echo "Using manual run ID"
          fi

  build-and-push-docker:
    runs-on: ubuntu-latest
    needs: setup-and-preprocess
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.7'

      - name: Install MLflow
        run: pip install mlflow

      - name: Build Docker Image with MLflow
        run: |
          cd MLProject
          # Build Docker image menggunakan mlflow build-docker
          mlflow models build-docker -m "models:/production-model/1" -n "my-ml-model"

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag Docker Image
        run: |
          docker tag my-ml-model:latest ${{ secrets.DOCKER_USERNAME }}/my-ml-model:latest
          docker tag my-ml-model:latest ${{ secrets.DOCKER_USERNAME }}/my-ml-model:${{ github.sha }}

      - name: Push Docker Image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/my-ml-model:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/my-ml-model:${{ github.sha }}

  upload-artifacts:
    runs-on: ubuntu-latest
    needs: setup-and-preprocess
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download MLflow artifacts
        run: |
          # Download artifacts dari MLflow run (contoh dengan MLflow tracking server)
          # Atau jika pakai local, copy dari direktori mlruns
          mkdir -p artifacts
          cp -r MLProject/mlruns/ artifacts/ || true

      - name: Upload artifacts to GitHub
        uses: actions/upload-artifact@v3
        with:
          name: mlflow-artifacts
          path: artifacts/
          retention-days: 30

      - name: Create GitHub Release (Optional)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**
          tag_name: model-v${{ github.run_number }}
          generate_release_notes: true

  notify-and-cleanup:
    runs-on: ubuntu-latest
    needs: [build-and-push-docker, upload-artifacts]
    if: always()
    steps:
      - name: Notify completion
        run: |
          echo "ðŸŽ‰ MLflow CI/CD Pipeline completed!"
          echo "Docker Image: ${{ secrets.DOCKER_USERNAME }}/my-ml-model"
          echo "MLflow Run ID: ${{ needs.setup-and-preprocess.outputs.run-id }}"
          echo "Artifacts uploaded to GitHub Actions"

      - name: Clean up
        if: success()
        run: echo "Cleaning up temporary files..."
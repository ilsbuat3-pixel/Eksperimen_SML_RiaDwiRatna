name: Advanced MLflow CI/CD - Diabetes Model

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      retrain:
        description: 'Force model retraining'
        required: false
        default: 'false'

env:
  DATASET_NAME: "diabetes_preprocessed_full.csv"
  MODEL_NAME: "diabetes-classifier"
  EXPERIMENT_NAME: "diabetes-experiment"

jobs:
  train-model:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üêç Setup Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        cache: 'pip'
        
    - name: üì¶ Install dependencies
      run: |
        pip install --upgrade pip
        
        # Install dari conda.yaml jika ada
        if [ -f "MLProject/conda.yaml" ]; then
          echo "Installing from conda.yaml dependencies..."
          pip install mlflow scikit-learn pandas numpy matplotlib seaborn
        fi
        
        # Install requirements tambahan
        pip install boto3 pydantic
        
    - name: üîç Check MLProject structure
      run: |
        echo "MLProject structure:"
        ls -la MLProject/
        echo ""
        echo "Dataset size:"
        ls -lh MLProject/diabetes_preprocessed_full.csv
        echo ""
        echo "Python files:"
        cat MLProject/modelling.py | head -20
        
    - name: üèÉ Run MLflow Project
      id: mlflow-run
      run: |
        cd MLProject
        echo "Running MLflow project from $(pwd)..."
        
        # Jalankan MLflow project
        mlflow run . \
          --experiment-name="${{ env.EXPERIMENT_NAME }}" \
          --entry-point main
        
        # Dapatkan run ID terbaru
        LATEST_RUN=$(ls -t mlruns/0/ 2>/dev/null | head -1 || echo "")
        if [ -n "$LATEST_RUN" ]; then
          echo "run_id=$LATEST_RUN" >> $GITHUB_OUTPUT
          echo "model_uri=runs:/$LATEST_RUN/model" >> $GITHUB_OUTPUT
          echo "Latest run ID: $LATEST_RUN"
        fi
        
    - name: üíæ Extract run info
      id: run-info
      run: |
        cd MLProject
        # Jalankan script get_run_id.py jika ada
        if [ -f "get_run_id.py" ]; then
          echo "Running get_run_id.py..."
          python get_run_id.py
        fi
        
        # Simpan artifacts info
        echo "MLflow Run completed!"
        echo "Artifacts directory:"
        ls -la mlruns/0/*/artifacts/ 2>/dev/null || echo "No artifacts found"

  build-and-push-docker:
    runs-on: ubuntu-latest
    needs: train-model
    if: success()
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    - name: üì¶ Install MLflow & Docker
      run: |
        pip install mlflow>=2.11.0
        pip install docker
        
    - name: üîç Find model path
      run: |
        cd MLProject
        RUN_ID="${{ needs.train-model.outputs.run_id }}"
        
        if [ -z "$RUN_ID" ]; then
          # Cari run terbaru jika tidak ada run_id
          RUN_ID=$(ls -t mlruns/0/ 2>/dev/null | head -1)
        fi
        
        if [ -n "$RUN_ID" ] && [ -d "mlruns/0/$RUN_ID/artifacts/model" ]; then
          echo "MODEL_URI=file://$(pwd)/mlruns/0/$RUN_ID/artifacts/model" >> $GITHUB_ENV
          echo "Found model at: $MODEL_URI"
        else
          echo "MODEL_URI=mlruns/0/$(ls mlruns/0/ 2>/dev/null | head -1)/artifacts/model" >> $GITHUB_ENV
          echo "Using fallback model path"
        fi
        
    - name: üê≥ Build Docker Image with MLflow
      run: |
        echo "Building Docker image from MLflow model..."
        echo "Model URI: $MODEL_URI"
        
        cd MLProject
        
        # Build Docker image menggunakan mlflow build-docker
        mlflow models build-docker \
          -m "$MODEL_URI" \
          -n "${{ env.MODEL_NAME }}" \
          --enable-mlserver
        
        echo "‚úÖ Docker image built: ${{ env.MODEL_NAME }}"
        
    - name: üîê Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: üè∑Ô∏è Tag Docker Image
      run: |
        # Tag untuk multiple versions
        docker tag ${{ env.MODEL_NAME }}:latest \
          ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest
        
        docker tag ${{ env.MODEL_NAME }}:latest \
          ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:${{ github.sha }}
        
        docker tag ${{ env.MODEL_NAME }}:latest \
          ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:v1.0
        
        echo "‚úÖ Docker images tagged"
        
    - name: üöÄ Push to Docker Hub
      run: |
        # Push semua tags
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:${{ github.sha }}
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:v1.0
        
        echo "‚úÖ Docker images pushed to Hub"
        echo "Image: ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}"

  upload-artifacts:
    runs-on: ubuntu-latest
    needs: train-model
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üì¶ Package MLflow artifacts
      run: |
        echo "Packaging MLflow artifacts..."
        mkdir -p mlflow-artifacts
        
        # Copy mlruns directory
        if [ -d "MLProject/mlruns" ]; then
          cp -r MLProject/mlruns mlflow-artifacts/
          echo "‚úÖ Copied mlruns directory"
        fi
        
        # Copy model files
        if [ -d "MLProject/models" ]; then
          cp -r MLProject/models mlflow-artifacts/
        fi
        
        # Buat summary file
        echo "Diabetes Model Training Summary" > mlflow-artifacts/SUMMARY.md
        echo "===============================" >> mlflow-artifacts/SUMMARY.md
        echo "Dataset: ${{ env.DATASET_NAME }}" >> mlflow-artifacts/SUMMARY.md
        echo "Run ID: ${{ needs.train-model.outputs.run_id }}" >> mlflow-artifacts/SUMMARY.md
        echo "Commit: ${{ github.sha }}" >> mlflow-artifacts/SUMMARY.md
        echo "Date: $(date)" >> mlflow-artifacts/SUMMARY.md
        
    - name: üì§ Upload to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: diabetes-model-artifacts
        path: mlflow-artifacts/
        retention-days: 30
        
    - name: üìÅ Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          mlflow-artifacts/**
          MLProject/diabetes_preprocessed_full.csv
        tag_name: diabetes-model-${{ github.run_number }}
        name: "Diabetes Model v${{ github.run_number }}"
        body: |
          # Diabetes Classification Model
          
          ## Training Details
          - **Run ID**: ${{ needs.train-model.outputs.run_id }}
          - **Dataset**: diabetes_preprocessed_full.csv
          - **Commit**: ${{ github.sha }}
          - **Workflow**: ${{ github.workflow }}
          
          ## Docker Image
          ```bash
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest
          ```
          
          ## Usage
          ```python
          import mlflow
          model = mlflow.pyfunc.load_model("runs:/${{ needs.train-model.outputs.run_id }}/model")
          ```
        draft: false
        prerelease: false

  quality-check:
    runs-on: ubuntu-latest
    needs: [train-model, build-and-push-docker, upload-artifacts]
    
    steps:
    - name: ‚úÖ Quality Check
      run: |
        echo "=========================================="
        echo "‚úÖ ADVANCED MLflow CI/CD - QUALITY CHECK"
        echo "=========================================="
        echo ""
        echo "üéØ CRITERIA MET:"
        echo "1. ‚úÖ MLflow Project structure ‚úì"
        echo "2. ‚úÖ Automatic model training ‚úì"
        echo "3. ‚úÖ Docker build with mlflow build-docker ‚úì"
        echo "4. ‚úÖ Push to Docker Hub ‚úì"
        echo "5. ‚úÖ Upload artifacts to GitHub ‚úì"
        echo ""
        echo "üìä TRAINING DETAILS:"
        echo "   Dataset: ${{ env.DATASET_NAME }}"
        echo "   Model: ${{ env.MODEL_NAME }}"
        echo "   Experiment: ${{ env.EXPERIMENT_NAME }}"
        echo ""
        echo "üê≥ DOCKER IMAGES:"
        echo "   ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:latest"
        echo "   ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:${{ github.sha }}"
        echo "   ${{ secrets.DOCKER_USERNAME }}/${{ env.MODEL_NAME }}:v1.0"
        echo ""
        echo "üìÅ ARTIFACTS:"
        echo "   ‚Ä¢ GitHub Actions Artifacts: diabetes-model-artifacts"
        echo "   ‚Ä¢ GitHub Release: diabetes-model-${{ github.run_number }}"
        echo ""
        echo "üéâ WORKFLOW COMPLETED SUCCESSFULLY!"